# Redis缓存设计

本文档定义了即时通信系统中Redis缓存的键设计和使用方式。

## 用户状态缓存

### 在线状态
- 键格式: `user:status:{user_id}`
- 值类型: 字符串
- 可能的值: 
  - "0" - 离线
  - "1" - 在线
  - "2" - 离开
  - "3" - 忙碌
- 过期时间: 不过期（用户下线时主动删除）
- 用途: 快速查询用户的在线状态

### 用户会话信息
- 键格式: `user:session:{user_id}`
- 值类型: Hash
- 字段:
  - token: 用户当前的会话token
  - login_time: 登录时间
  - client_ip: 客户端IP地址
  - client_device: 客户端设备信息
- 过期时间: 24小时
- 用途: 存储用户的会话信息

### 用户连接信息
- 键格式: `user:connection:{user_id}`
- 值类型: Set
- 成员: 连接标识符，例如WebSocket连接ID或gRPC流ID
- 过期时间: 不过期（用户下线时主动删除）
- 用途: 存储用户的所有活跃连接（支持多端登录）

## 验证码缓存

### 邮箱验证码
- 键格式: `verification:email:{email}`
- 值类型: String
- 值: 6位数字验证码
- 过期时间: 5分钟
- 用途: 存储邮箱验证码，验证成功后删除

## 消息缓存

### 最近会话列表
- 键格式: `user:recent_chats:{user_id}`
- 值类型: ZSet (有序集合)
- 成员: 好友ID或群组ID（格式为"u:{user_id}"或"g:{group_id}"）
- 分数: 最后一条消息的时间戳
- 过期时间: 不过期
- 用途: 存储用户的最近聊天会话，按最后通信时间排序

### 未读消息计数
- 键格式: `user:unread:{user_id}:{chat_id}`
- 值类型: String (整数)
- 值: 未读消息数量
- 过期时间: 不过期
- 用途: 存储特定聊天的未读消息数量

### 最近消息缓存
- 键格式: `chat:messages:{chat_type}:{chat_id}`
- 值类型: List
- 成员: 消息的JSON字符串
- 过期时间: 1天
- 用途: 缓存最近的聊天消息（个人聊天或群组聊天）
- 注意: chat_type可以是"personal"或"group"

## 好友和群组缓存

### 好友列表缓存
- 键格式: `user:friends:{user_id}`
- 值类型: Hash
- 字段: friend_id -> 备注名(如果有)或空字符串
- 过期时间: 1小时
- 用途: 缓存用户的好友列表

### 群组成员缓存
- 键格式: `group:members:{group_id}`
- 值类型: Hash
- 字段: user_id -> 角色(0: 普通成员, 1: 管理员, 2: 群主)
- 过期时间: 1小时
- 用途: 缓存群组的成员列表

## 限流和安全

### 登录失败计数
- 键格式: `limit:login_fail:{email}`
- 值类型: String (整数)
- 值: 登录失败次数
- 过期时间: 30分钟
- 用途: 防止密码暴力破解

### API请求限流
- 键格式: `limit:api:{user_id}:{api_name}`
- 值类型: String (整数)
- 值: 一定时间内的请求次数
- 过期时间: 根据API不同，一般为1分钟到1小时
- 用途: API请求速率限制

## 文件传输

### 文件传输状态
- 键格式: `file:transfer:{request_id}`
- 值类型: Hash
- 字段:
  - status: 传输状态(0:待处理, 1:传输中, 2:已完成, 3:失败, 4:拒绝)
  - progress: 传输进度百分比
  - current_chunk: 当前传输的块索引
  - total_chunks: 总块数
- 过期时间: 1小时
- 用途: 追踪文件传输状态和进度

## Pub/Sub频道

### 用户状态变更
- 频道名: `channel:user_status`
- 消息格式: JSON字符串，包含user_id和新状态
- 用途: 广播用户上线/下线状态变更

### 系统通知
- 频道名: `channel:system_notification:{user_id}`
- 消息格式: 通知内容JSON字符串
- 用途: 向特定用户推送系统通知

### 好友请求通知
- 频道名: `channel:friend_request:{user_id}`
- 消息格式: 好友请求JSON字符串
- 用途: 向用户推送新的好友请求

### 消息通知
- 频道名: `channel:message:{user_id}`
- 消息格式: 新消息JSON字符串
- 用途: 向用户推送新消息通知

## 用户日活统计

### 日活跃用户集合
- 键格式: `stats:dau:{date}` (例如 stats:dau:2023-04-10)
- 值类型: Set
- 成员: 用户ID
- 过期时间: 30天
- 用途: 统计每日活跃用户

## 通用缓存策略

1. 对于频繁访问但很少修改的数据（如用户信息），使用较长的过期时间
2. 对于频繁变更的数据（如聊天消息），使用较短的过期时间或不缓存
3. 在数据更新时，同步更新缓存或者直接删除缓存，让系统在下次请求时重新加载
4. 对于关键业务数据，总是保持数据库和缓存的一致性 